{%- comment -%}
Core GitHub issue form. Accepts either:
  a) include.block.* fields, OR
  b) direct named params on the include (repo=, label=, ...)

Expected fields:
  repo (owner/repo), label, extra_labels (array), title_prefix,
  heading, byline, icon, wrapper_class, open_in_new_tab (bool), body_template
{%- endcomment -%}

{%- assign src = include.block | default: include -%}
{%- assign _repo   = src.repo -%}
{%- assign _label  = src.label | default: 'contact' -%}
{%- assign _extras = src.extra_labels -%}
{%- assign _titlep = src.title_prefix | default: '' -%}
{%- assign _head   = src.heading | default: 'Get in Touch' -%}
{%- assign _by     = src.byline -%}
{%- assign _icon   = src.icon | default: 'fa-regular fa-envelope' -%}
{%- assign _wrap   = src.wrapper_class | default: 'wrapper style4 special container medium' -%}
{%- assign _newtab = src.open_in_new_tab -%}
{%- if _newtab == nil -%}{% assign _newtab = true %}{%- endif -%}

{%- assign _tmpl = src.body_template -%}{%- comment -%} CAPTURE TEMPLATE HERE {%- endcomment -%}

{%- if _repo -%}
  <section class="{{ _wrap }}">
    <div class="content">

      <header class="special">
        <span class="icon {{ _icon }}"></span>
        <h2>{{ _head }}</h2>
        {% if _by %}<p>{{ _by }}</p>{% endif %}
      </header>

      <form onsubmit="return createIssue_{{ _repo | replace: '/', '_' }}(event)">
        <div class="row gtr-50">
          <div class="col-6 col-12-mobile">
            <label class="visually-hidden" for="gh-name">Name</label>
            <input id="gh-name" type="text" placeholder="Name" />
          </div>
          <div class="col-6 col-12-mobile">
            <label class="visually-hidden" for="gh-email">Email (optional)</label>
            <input id="gh-email" type="email" placeholder="Email (optional)" />
          </div>
          <div class="col-12">
            <label class="visually-hidden" for="gh-subject">Subject</label>
            <input id="gh-subject" type="text" placeholder="Subject" />
          </div>
          <div class="col-12">
            <label class="visually-hidden" for="gh-message">Message</label>
            <textarea id="gh-message" placeholder="Your message" rows="7"></textarea>
          </div>
          <div class="col-12">
            <ul class="buttons">
              <li><button class="special" type="submit">Open GitHub Issue</button></li>
              <li><button type="reset">Clear</button></li>
            </ul>
            <p class="byline" style="margin-top:.5rem">
              Weâ€™ll pre-fill the issue with your details then send you to GitHub to submit.
            </p>
          </div>
        </div>
      </form>

      <script>
        function createIssue_{{ _repo | replace: '/', '_' }}(e) {
          e.preventDefault();

          var name    = document.getElementById('gh-name').value.trim();
          var email   = document.getElementById('gh-email').value.trim();
          var subject = document.getElementById('gh-subject').value.trim();
          var message = document.getElementById('gh-message').value.trim();

          var title = "{{ _titlep | escape }}"+ (subject || "New request");
          var lines = [];
          if (name)  lines.push("**Name:** " + name);
          if (email) lines.push("**Email:** " + email);
          if (subject) lines.push("**Subject:** " + subject);
          if (message) {
            lines.push("");
            lines.push("---");
            lines.push("");
            lines.push(message);
          }
          var body = lines.join("\n");

          // Append preset body template, if provided
          var template = {{ _tmpl | jsonify }};
          if (template && template.trim()) {
            if (body) body += "\n\n---\n\n";
            body += template;
          }

          var labels = [];
          {% if _label %}labels.push("{{ _label | escape }}");{% endif %}
          {% if _extras %}
            {% for l in _extras %}labels.push("{{ l | escape }}");{% endfor %}
          {% endif %}

          var params = new URLSearchParams();
          params.set("title", title);
          if (body) params.set("body", body);
          if (labels.length) params.set("labels", labels.join(","));

          var url = "https://github.com/{{ _repo }}/issues/new?" + params.toString();
          {% if _newtab %} window.open(url, "_blank", "noopener"); {% else %} window.location.href = url; {% endif %}
          return false;
        }
      </script>

      <hr />
      <p>
        Issues are filed in <a target="_blank" rel="noopener" href="https://github.com/{{ _repo }}/issues">github.com/{{ _repo }}</a>.
        Ensure these labels exist in the repository.
      </p>
    </div>
  </section>
{%- else -%}
  <div class="notice">github_issue_form: please provide <code>repo</code>.</div>
{%- endif -%}
