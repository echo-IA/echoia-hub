{%- assign data_path = include.data_path | default: '/data/catalogs.csv' -%}
{%- assign container_id = include.container_id | default: 'catalogs-list' -%}
{%- assign empty_id = include.empty_id | default: 'catalogs-empty' -%}
{%- assign controls_id = include.controls_id | default: 'catalogs-controls' -%}

<section class="wrapper style4 container">
  <div class="content">
    <!-- Filters UI -->
    <div id="{{ controls_id }}" class="catalog-filters" style="margin-bottom:1rem;"></div>

    <!-- Results -->
    <div id="{{ container_id }}"></div>
    <p id="{{ empty_id }}" style="display:none;">No catalogs match your filters.</p>
  </div>
</section>

<script>
(function() {
  const dataUrl     = "{{ data_path | relative_url }}";
  const containerId = "{{ container_id }}";
  const emptyId     = "{{ empty_id }}";
  const controlsId  = "{{ controls_id }}";

  const esc = (s) => (s || '').toString().replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
  const num = (x) => {
    if (x === null || x === undefined) return null;
    const v = parseFloat(String(x).replace(/[^\d.+-eE]/g,''));
    return Number.isFinite(v) ? v : null;
  };

  // Normalize redshift type → 'photo-z' | 'spec-z' | 'other'
  const normType = (t) => {
    t = (t || '').toString().trim().toLowerCase();
    if (!t) return 'other';
    if (/(photo|photometric|pz|photo-z)/.test(t)) return 'photo-z';
    if (/(spec|spectro|sz|spec-z)/.test(t)) return 'spec-z';
    return 'other';
  };

  document.addEventListener('DOMContentLoaded', function() {
    const wrap   = document.getElementById(containerId);
    const empty  = document.getElementById(emptyId);
    const ctrl   = document.getElementById(controlsId);

    if (!wrap) return;

    if (typeof Papa === 'undefined') {
      console.error('PapaParse not loaded. Include scripts with papaparse=true.');
      empty.style.display = 'block';
      return;
    }

    Papa.parse(dataUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: ({ data }) => init(data),
      error: (err) => { console.error('CSV load error:', err); empty.style.display='block'; }
    });

    function init(rowsRaw) {
      // Shape raw rows into a consistent object
      const rows = rowsRaw.map(r => {
        const redshift_type =
          r.redshift_type ?? r['redshift type'] ?? r.photo_vs_spec ?? r['photo vs spec'] ?? r.ztype ?? '';
        const sky_area = r.sky_area_deg2 ?? r['sky area'] ?? r.area ?? '';
        const year = r.year ?? r.release_year ?? r.publication_year ?? '';
        return {
          _raw: r, // keep original for display fields already handled
          name: r.name ?? r.sample ?? 'Untitled',
          redshift_type_raw: redshift_type,
          redshift_type_norm: normType(redshift_type),
          sky_area_num: num(sky_area),
          year_num: year ? parseInt(String(year).match(/\d{4}/)?.[0] ?? '', 10) : null,
          search_blob: [
            r.name, r.sample, r.survey, r['redshift source'], r.shape_measurement, r['shape source'],
            r.aux, r.notes
          ].filter(Boolean).join(' ').toLowerCase()
        };
      });

      // Stats for controls
      const types = Array.from(new Set(rows.map(r => r.redshift_type_norm))).filter(Boolean).sort();
      const haveYear = rows.some(r => Number.isFinite(r.year_num));
      const areaVals = rows.map(r => r.sky_area_num).filter(v => Number.isFinite(v));
      const yrVals   = rows.map(r => r.year_num).filter(v => Number.isFinite(v));
      const areaMin  = areaVals.length ? Math.floor(Math.min(...areaVals)) : 0;
      const areaMax  = areaVals.length ? Math.ceil(Math.max(...areaVals))  : 100;
      const yearMin  = haveYear ? Math.min(...yrVals) : 2000;
      const yearMax  = haveYear ? Math.max(...yrVals) : 2030;

      // Filter state
      const state = {
        search: '',
        types: new Set(types),          // all selected by default
        areaMin, areaMax,               // numeric window
        yearMin, yearMax, useYear: haveYear
      };

      renderControls(ctrl, types, state, haveYear);
      renderFiltered();

      // --- helpers ---
      function renderControls(root, types, st, showYear) {
        root.innerHTML = `
<div class="cf-row">
  <input id="cf-search" type="search" placeholder="Search catalogs…" />
  <button id="cf-reset" type="button" class="button small">Reset</button>
</div>
<div class="cf-row">
  <div class="cf-group">
    <label class="cf-label">Type</label>
    <div class="cf-chips">
      ${types.map(t => `
        <label><input type="checkbox" class="cf-type" value="${t}" checked> ${t}</label>
      `).join('')}
    </div>
  </div>
  <div class="cf-group">
    <label class="cf-label">Area (deg²)</label>
    <div class="cf-range">
      <input id="cf-area-min" type="number" step="1" min="${areaMin}" max="${areaMax}" value="${st.areaMin}">
      <span>–</span>
      <input id="cf-area-max" type="number" step="1" min="${areaMin}" max="${areaMax}" value="${st.areaMax}">
    </div>
  </div>
  ${showYear ? `
  <div class="cf-group">
    <label class="cf-label">Year</label>
    <div class="cf-range">
      <input id="cf-year-min" type="number" step="1" min="${yearMin}" max="${yearMax}" value="${st.yearMin}">
      <span>–</span>
      <input id="cf-year-max" type="number" step="1" min="${yearMin}" max="${yearMax}" value="${st.yearMax}">
    </div>
  </div>` : ''}
</div>
        `;

        // Wire events
        root.querySelector('#cf-search').addEventListener('input', e => { st.search = e.target.value.toLowerCase(); renderFiltered(); });
        root.querySelectorAll('.cf-type').forEach(cb => cb.addEventListener('change', (e) => {
          const v = e.target.value;
          if (e.target.checked) st.types.add(v); else st.types.delete(v);
          renderFiltered();
        }));
        root.querySelector('#cf-area-min').addEventListener('input', e => { st.areaMin = num(e.target.value) ?? areaMin; renderFiltered(); });
        root.querySelector('#cf-area-max').addEventListener('input', e => { st.areaMax = num(e.target.value) ?? areaMax; renderFiltered(); });
        if (showYear) {
          root.querySelector('#cf-year-min').addEventListener('input', e => { st.yearMin = parseInt(e.target.value||yearMin,10); renderFiltered(); });
          root.querySelector('#cf-year-max').addEventListener('input', e => { st.yearMax = parseInt(e.target.value||yearMax,10); renderFiltered(); });
        }
        root.querySelector('#cf-reset').addEventListener('click', () => {
          st.search = '';
          st.types  = new Set(types);
          st.areaMin = areaMin; st.areaMax = areaMax;
          if (showYear) { st.yearMin = yearMin; st.yearMax = yearMax; }
          renderControls(root, types, st, showYear); // re-render controls to reset UI
          renderFiltered();
        });
      }

      function renderFiltered() {
        const out = rows.filter(r => {
          // search
          if (state.search && !r.search_blob.includes(state.search)) return false;
          // type
          if (!state.types.has(r.redshift_type_norm)) return false;
          // area window (ignore filter when value missing)
          if (Number.isFinite(r.sky_area_num)) {
            if (r.sky_area_num < state.areaMin || r.sky_area_num > state.areaMax) return false;
          }
          // year window (only if dataset has years)
          if (state.useYear && Number.isFinite(r.year_num)) {
            if (r.year_num < state.yearMin || r.year_num > state.yearMax) return false;
          }
          return true;
        });

        // Render as HTML (reuse your existing card template logic in JS)
        if (!out.length) { empty.style.display='block'; wrap.innerHTML=''; return; }
        empty.style.display='none';

        wrap.innerHTML = out.map(({_raw: r}) => {
          const name    = esc(r.name || r.sample || 'Untitled');
          const survey  = esc(r.survey || r['redshift source'] || '');
          const ztype   = esc(r.redshift_type || r['redshift type'] || r.photo_vs_spec || r['photo vs spec'] || '');
          const shape   = esc(r.shape_measurement || r['shape source'] || '');
          const area    = esc(r.sky_area_deg2 || r['sky area'] || '');
          const nClust  = esc(r.n_gal_clustering || r['number of objects for clustering'] || '');
          const nShapes = esc(r.n_gal_shapes || r['number of objects for shapes'] || '');
          const auxRaw  = (r.aux_info || r['auxiliary info'] || '');
          const license = esc(r.license || '');
          const doiRaw  = (r.doi  || '').trim();
          const linkRaw = (r.link || '').trim();
          const doiHref = doiRaw ? `https://doi.org/${esc(doiRaw)}` : '';

          const linkHtml = [
            doiRaw  ? `<a class="ext" target="_blank" rel="noopener" href="${doiHref}">DOI</a>` : '',
            linkRaw ? `<a class="ext" target="_blank" rel="noopener" href="${esc(linkRaw)}">Data</a>` : ''
          ].filter(Boolean).join(' · ');

          const metaBits = [
            survey,
            ztype ? `${ztype}` : '',
            area ? `${area} deg²` : '',
            nShapes ? `shapes: ${nShapes}` : ''
          ].filter(Boolean).join(' · ');

          // same HTML as your existing renderer
          return `
<details class="catalog">
  <summary>
    <span class="name">${name}${linkHtml ? ` <span class="ext">· ${linkHtml}</span>` : ''}</span>
    <span class="meta">${metaBits}</span>
  </summary>
  <div class="catalog-details">
    <div class="cols">
      <div>
        <h5>Redshift source</h5>
        <div>${survey}${ztype ? ` (${ztype})` : ''}</div>
      </div>
      <div>
        <h5>Shape source</h5>
        <div>${shape}</div>
      </div>
      <div>
        <h5>Sky area</h5>
        <div>${area ? `${area} deg²` : ''}</div>
      </div>
      <div>
        <h5>Objects (clustering)</h5>
        <div>${nClust}</div>
      </div>
      <div>
        <h5>Objects (shapes)</h5>
        <div>${nShapes}</div>
      </div>
      <div>
        <h5>Auxiliary info</h5>
        <div>${ax(auxRaw)}</div>
      </div>
      <div>
        <h5>License</h5>
        <div>${license}</div>
      </div>
      ${r.notes ? `
      <div style="grid-column: 1 / -1;">
        <h5>Notes</h5>
        <div>${esc(r.notes)}</div>
      </div>` : ''}
      <div class="links" style="grid-column: 1 / -1;">
        ${linkHtml}
      </div>
    </div>
  </div>
</details>`;
        }).join('');
      }

      function ax(s) {
        const t = (s || '').toString().trim();
        if (!t) return '';
        return esc(t.replace(/\s*,\s*/g, ', '));
      }
    }
  });
})();
</script>
